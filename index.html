<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IMP Note App</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- RENK PALETƒ∞ --- */
            --bg-body: #0c0b0b;
            --bg-card: #141313;
            --border-subtle: rgba(194, 178, 128, 0.2);
            
            --accent-primary: #C2B280; /* Gold */
            --accent-soft: #f0fff0;   /* Zar Butonu Rengi */
            
            --text-main: #e0d8c3;
            --text-muted: #757065;
            
            --font-display: 'Rajdhani', sans-serif;
            --font-body: 'Inter', sans-serif;
            
            --sidebar-width: 280px;
            --bottom-safe: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at 50% 0%, #1f1c18 0%, #0c0b0b 70%);
            color: var(--text-main); font-family: var(--font-body);
            margin: 0; height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- UI ELEMENTS --- */
        .menu-trigger, .settings-trigger {
            position: absolute; top: 16px; z-index: 60; background: transparent; border: none;
            color: var(--accent-primary); font-size: 1.8rem; cursor: pointer; padding: 10px;
        }
        .menu-trigger { left: 16px; }
        .settings-trigger { right: 16px; color: var(--text-muted); font-size: 1.4rem; }

        /* SIDEBAR */
        aside {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: rgba(12, 11, 11, 0.98); border-right: 1px solid var(--border-subtle);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100; display: flex; flex-direction: column; padding: 80px 20px 20px 20px;
        }
        aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
        .backdrop {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6);
            z-index: 90; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .backdrop.show { display: block; opacity: 1; }

        /* SIDEBAR ITEMS */
        .sidebar-label { font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 2px; color: var(--text-muted); margin: 20px 0 10px 0; font-weight: 700; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .btn-sidebar-action { background: rgba(255,255,255,0.05); color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; border: 1px solid var(--border-subtle); text-align: left; margin-bottom: 5px; transition: 0.2s; font-family: var(--font-display); font-size: 1rem; }
        .btn-sidebar-action:hover { background: var(--accent-primary); color: #000; }
        
        .tag-item { display: flex; justify-content: space-between; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-family: var(--font-display); font-weight: 600; font-size: 1.1rem; }
        .tag-item:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .tag-options { background: none; border: none; color: #666; cursor: pointer; opacity: 0; }
        .tag-item:hover .tag-options { opacity: 1; }

        /* MAIN CONTENT */
        main { flex: 1; display: flex; flex-direction: column; padding: 70px 20px 0 20px; width: 100%; max-width: 700px; margin: 0 auto; }
        
        .card-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-bottom: 20px; }
        .card {
            background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 20px;
            padding: 30px; display: flex; flex-direction: column; height: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); position: relative;
        }
        .card-meta { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .badge { color: var(--accent-primary); font-family: var(--font-display); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .stars-display { color: #d4af37; letter-spacing: 2px; }
        .card-text { font-size: 1.25rem; line-height: 1.6; color: #dacfb8; flex: 1; overflow-y: auto; white-space: pre-wrap; }
        .card-text b { color: #fff; font-weight: 700; }

        /* FIXED BOTTOM ACTIONS */
        .bottom-actions {
            flex-shrink: 0; display: flex; justify-content: center; gap: 20px;
            padding-bottom: calc(20px + var(--bottom-safe));
        }
        .btn-icon {
            width: 60px; height: 60px; border-radius: 18px; border: 1px solid var(--border-subtle);
            font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: #333;
        }
        .btn-icon:active { transform: scale(0.95); }

        /* BUTTON COLORS */
        .btn-edit { background-color: #fce4ec; color: #880e4f; } /* Soft Pink */
        .btn-add  { background-color: #e3f2fd; color: #0d47a1; } /* Soft Blue */
        
        /* ZAR BUTONU (Rastgele) */
        .btn-random { background-color: #f0fff0; color: #1b5e20; } /* Honeydew */
        
        /* --- RICH TEXT EDITOR (MacOS TextEdit Style) --- */
        .editor-container {
            display: flex; flex-direction: column; height: 100%; gap: 10px;
        }
        
        .rich-toolbar {
            display: flex; gap: 5px; background: #222; padding: 8px; border-radius: 10px; flex-wrap: wrap; align-items: center; border: 1px solid #333;
        }
        
        .rt-btn {
            background: #333; border: none; color: #ccc; width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            font-family: serif; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
        }
        .rt-btn:hover { background: var(--accent-primary); color: #000; }
        .rt-btn svg { width: 18px; height: 18px; }

        .color-input-wrapper {
            width: 32px; height: 32px; border-radius: 50%; overflow: hidden; border: 2px solid #444; cursor: pointer;
        }
        input[type="color"] { width: 150%; height: 150%; transform: translate(-25%, -25%); border: none; cursor: pointer; }

        .editor-canvas {
            flex: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 10px;
            padding: 15px; color: #eee; font-size: 1.1rem; line-height: 1.5; overflow-y: auto; outline: none;
            min-height: 150px;
        }
        .editor-canvas:focus { border-color: var(--accent-primary); }

        /* --- VISUAL STAR RATING (Interactive) --- */
        .star-rating-interactive {
            display: flex; justify-content: center; gap: 8px; margin: 15px 0;
        }
        .star-btn {
            background: none; border: none; font-size: 2rem; color: #444; cursor: pointer; transition: 0.2s; line-height: 1; padding: 0;
        }
        .star-btn.active { color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .star-btn:hover { transform: scale(1.2); }

        /* MODALS */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #111; border: 1px solid var(--border-subtle); padding: 25px;
            border-radius: 20px; width: 90%; max-width: 500px;
            box-shadow: 0 0 50px rgba(0,0,0,0.9); display: flex; flex-direction: column;
            max-height: 85vh;
        }
        .modal-header { font-family: var(--font-display); font-size: 1.2rem; color: var(--accent-primary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }

        select, input[type="text"] {
            width: 100%; background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none;
        }

        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .btn-modal { padding: 10px 20px; border-radius: 50px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn-save { background: var(--accent-primary); color: #000; }
        .btn-cancel { background: transparent; color: #888; }
        .btn-cancel:hover { color: #fff; }

        /* TOAST */
        .toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 10px 20px; border-radius: 50px;
            font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300;
        }
        .toast.show { opacity: 1; bottom: 140px; }

    </style>
</head>
<body>

    <button class="menu-trigger" onclick="toggleSidebar()">‚ò∞</button>
    <button class="settings-trigger" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="btn-sidebar-action" onclick="resetFilter()">‚àû T√úM NOTLAR</div>
        
        <div class="sidebar-label">KATEGORƒ∞LER</div>
        <div class="scroll-area" id="sidebar-tag-list" style="flex:1;"></div>
        <div class="btn-sidebar-action" onclick="openNewTagModal()">+ YENƒ∞ KATEGORƒ∞</div>

        <div class="sidebar-label">√ñNEM Fƒ∞LTRESƒ∞</div>
        <div id="sidebar-rating-list">
            </div>

        <div style="font-size:0.7rem; color:#444; text-align:center; padding-top:10px;" id="status-text">OFFLINE</div>
    </aside>

    <main>
        <div class="card-container">
            <div class="card" id="card">
                <div class="card-meta">
                    <span class="badge" id="d-tag">IMP</span>
                    <span class="stars-display" id="d-stars">‚òÖ‚òÖ‚òÖ</span>
                </div>
                <div class="card-text" id="d-text">Sistem Ba≈ülatƒ±lƒ±yor...</div>
            </div>
        </div>

        <div class="bottom-actions">
            <button class="btn-icon btn-edit" onclick="openEditModal()">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
            
            <button class="btn-icon btn-random" onclick="showRandom()">
               <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><circle cx="7.5" cy="7.5" r="1.5" fill="currentColor"></circle><circle cx="16.5" cy="16.5" r="1.5" fill="currentColor"></circle><circle cx="16.5" cy="7.5" r="1.5" fill="currentColor"></circle><circle cx="7.5" cy="16.5" r="1.5" fill="currentColor"></circle><circle cx="12" cy="12" r="1.5" fill="currentColor"></circle></svg>
            </button>
            
            <button class="btn-icon btn-add" onclick="openAddNoteModal()">
               <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
    </main>

    <div class="toast" id="toast">Bilgi</div>

    <div class="modal-overlay" id="modal-add">
        <div class="modal-box">
            <div class="modal-header">Yeni Not</div>
            
            <div class="rich-toolbar">
                <button class="rt-btn" onclick="formatText('bold')"><b>B</b></button>
                <button class="rt-btn" onclick="formatText('italic')"><i>I</i></button>
                <button class="rt-btn" onclick="formatText('underline')"><u>U</u></button>
                <div class="color-input-wrapper" title="Metin Rengi">
                    <input type="color" onchange="formatText('foreColor', this.value)">
                </div>
                <button class="rt-btn" onclick="formatText('justifyLeft')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 21h18v-2H3v2zm0-4h12v-2H3v2zm0-4h18v-2H3v2zm0-4h12V7H3v2zm0-6v2h18V3H3z"/></svg></button>
                <button class="rt-btn" onclick="formatText('justifyCenter')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                <button class="rt-btn" onclick="formatText('justifyRight')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
            </div>

            <div class="editor-canvas" id="add-editor" contenteditable="true" placeholder="Notunuzu buraya yazƒ±n..."></div>
            
            <select id="add-tag-select"></select>
            
            <div class="star-rating-interactive" id="add-stars-container">
                </div>

            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-add')">ƒ∞ptal</button>
                <button class="btn-modal btn-save" onclick="runAddNote()">KAYDET</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-edit">
        <div class="modal-box">
            <div class="modal-header">D√ºzenle</div>
            
            <div class="rich-toolbar">
                <button class="rt-btn" onclick="formatText('bold')"><b>B</b></button>
                <button class="rt-btn" onclick="formatText('italic')"><i>I</i></button>
                <button class="rt-btn" onclick="formatText('underline')"><u>U</u></button>
                <div class="color-input-wrapper">
                    <input type="color" onchange="formatText('foreColor', this.value)">
                </div>
                <button class="rt-btn" onclick="formatText('justifyLeft')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 21h18v-2H3v2zm0-4h12v-2H3v2zm0-4h18v-2H3v2zm0-4h12V7H3v2zm0-6v2h18V3H3z"/></svg></button>
                <button class="rt-btn" onclick="formatText('justifyCenter')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
            </div>

            <div class="editor-canvas" id="edit-editor" contenteditable="true"></div>
            <select id="edit-tag-select"></select>
            
            <div class="star-rating-interactive" id="edit-stars-container"></div>

            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-edit')">ƒ∞ptal</button>
                <button class="btn-modal btn-save" onclick="saveEdit()">G√úNCELLE</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-settings">
        <div class="modal-box">
            <div class="modal-header">Ayarlar</div>
            <input type="text" id="settings-url" placeholder="Google Script URL">
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-settings')">ƒ∞ptal</button>
                <button class="btn-modal btn-save" onclick="saveSettings()">KAYDET</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-new-tag">
        <div class="modal-box">
            <div class="modal-header">Yeni Kategori</div>
            <input type="text" id="new-tag-name" placeholder="ƒ∞sim Giriniz">
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-new-tag')">ƒ∞ptal</button>
                <button class="btn-modal btn-save" onclick="createTag()">OLU≈ûTUR</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-tag-options">
        <div class="modal-box">
            <div class="modal-header" id="opt-tag-name">Se√ßenekler</div>
            <button class="btn-sidebar-action" onclick="openRenameFromOptions()">‚úé Yeniden Adlandƒ±r</button>
            <button class="btn-sidebar-action" style="border-color:#b71c1c; color:#ffcdd2;" onclick="runDeleteTag()">üóë Sil</button>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-tag-options')">Kapat</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-rename-tag">
        <div class="modal-box">
            <div class="modal-header">Yeniden Adlandƒ±r</div>
            <input type="text" id="rename-tag-input">
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-rename-tag')">ƒ∞ptal</button>
                <button class="btn-modal btn-save" onclick="runRenameTag()">KAYDET</button>
            </div>
        </div>
    </div>

<script>
    let GOOGLE_SCRIPT_URL = localStorage.getItem('imp_app_url');
    let notes = [];
    let tags = [];
    let currentFilter = { type: 'all', val: null };
    let currentIndex = -1;
    let targetTagForOptions = "";
    
    // YILDIZ PUANI TUTUCULARI
    let tempRatingAdd = 0;
    let tempRatingEdit = 0;

    const tagColors = ["#808000", "#8b4513", "#4682b4", "#ff6347", "#556b2f", "#cd853f", "#2e8b57", "#a0522d"];

    window.onload = function() {
        renderStarSelector('add-stars-container', 'tempRatingAdd');
        renderStarSelector('edit-stars-container', 'tempRatingEdit');
        renderRatingSidebar();
        
        if(!GOOGLE_SCRIPT_URL) {
            openSettings();
            document.getElementById('d-text').innerText = "L√ºtfen Ayarlar'dan Google URL'nizi girin.";
        } else {
            fetchNotes(); 
        }
    };

    /* --- UI HELPERS --- */
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('backdrop').classList.toggle('show'); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    
    // RICH TEXT FORMATTER
    function formatText(cmd, value=null) {
        document.execCommand(cmd, false, value);
        // Edit√∂r odaƒüƒ±nƒ± korumak i√ßin
        const activeEditor = document.activeElement; 
        if(activeEditor && activeEditor.classList.contains('editor-canvas')) {
            activeEditor.focus();
        }
    }

    // STAR RATING RENDERER
    function renderStarSelector(containerId, varName) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        for(let i=1; i<=5; i++) {
            const btn = document.createElement('button');
            btn.className = 'star-btn';
            btn.innerHTML = '‚òÖ';
            btn.onclick = () => setStar(i, varName, containerId);
            container.appendChild(btn);
        }
    }

    function setStar(rating, varName, containerId) {
        // Global deƒüi≈ükeni g√ºncelle
        if(varName === 'tempRatingAdd') tempRatingAdd = rating;
        if(varName === 'tempRatingEdit') tempRatingEdit = rating;

        // UI G√ºncelle
        const container = document.getElementById(containerId);
        const stars = container.getElementsByClassName('star-btn');
        for(let i=0; i<stars.length; i++) {
            if(i < rating) stars[i].classList.add('active');
            else stars[i].classList.remove('active');
        }
    }

    /* --- DATA --- */
    async function fetchNotes() {
        if(!GOOGLE_SCRIPT_URL) return;
        try {
            document.getElementById('status-text').innerText = "G√úNCELLENƒ∞YOR...";
            const res = await fetch(GOOGLE_SCRIPT_URL);
            const data = await res.json();
            if(Array.isArray(data)) {
                notes = data;
                extractTags();
                renderSidebarTags();
                document.getElementById('status-text').innerText = "ONLINE";
                showRandom();
            }
        } catch(e) { document.getElementById('status-text').innerText = "BAƒûLANTI YOK"; }
    }

    async function saveToGoogle(data) {
        document.getElementById('status-text').innerText = "KAYDEDƒ∞Lƒ∞YOR...";
        try {
            await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify(data) });
            document.getElementById('status-text').innerText = "KAYDEDƒ∞LDƒ∞";
        } catch(e) { showToast("Kayƒ±t Hatasƒ±"); }
    }

    /* --- SIDEBAR --- */
    function extractTags() {
        const s = new Set(["Genel", "√ñnemli", "Fikirler"]);
        notes.forEach(n => { if(n.tag) s.add(n.tag); });
        tags = Array.from(s).sort();
    }
    
    function stringToColor(str) {
        let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        return '#' + "00000".substring(0, 6 - c.length) + c;
    }

    function renderSidebarTags() {
        const c = document.getElementById('sidebar-tag-list'); c.innerHTML = '';
        tags.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'tag-item';
            const color = tagColors[i % tagColors.length];
            div.style.borderLeft = `4px solid ${color}`;
            div.innerHTML = `
                <span class="tag-text" style="color:${color}; margin-left:10px;">${t}</span>
                <button class="tag-options" onclick="event.stopPropagation(); openTagOptions('${t}')">‚ãÆ</button>
            `;
            div.onclick = () => filterByTag(t);
            c.appendChild(div);
        });
        updateSelects();
    }

    function renderRatingSidebar() {
        const c = document.getElementById('sidebar-rating-list'); c.innerHTML = '';
        for(let i=5; i>=1; i--) {
            const div = document.createElement('div');
            div.className = 'btn-sidebar-action';
            div.style.border = 'none';
            div.innerHTML = `<span style="color:#d4af37; margin-right:8px;">${'‚òÖ'.repeat(i)}</span> ${i} Yƒ±ldƒ±z`;
            div.onclick = () => filterByRating(i);
            c.appendChild(div);
        }
    }

    function updateSelects() {
        const fill = (id) => {
            const el = document.getElementById(id); el.innerHTML = '';
            tags.forEach(t => { const o = document.createElement('option'); o.value=t; o.innerText=t; el.appendChild(o); });
        };
        fill('add-tag-select'); fill('edit-tag-select');
    }

    /* --- FILTER & DISPLAY --- */
    function resetFilter() { currentFilter = {type:'all'}; toggleSidebar(); showRandom(); showToast("T√ºm Notlar"); }
    function filterByTag(t) { currentFilter = {type:'tag', val:t}; toggleSidebar(); showRandom(); }
    function filterByRating(r) { currentFilter = {type:'rating', val:r}; toggleSidebar(); showRandom(); }

    function showRandom() {
        let list = notes;
        if(currentFilter.type === 'tag') list = notes.filter(n => n.tag === currentFilter.val);
        if(currentFilter.type === 'rating') list = notes.filter(n => parseInt(n.rating) === currentFilter.val);

        if(list.length === 0) {
            document.getElementById('d-text').innerText = "Bu filtrede not bulunamadƒ±.";
            document.getElementById('d-tag').innerText = "-";
            document.getElementById('d-stars').innerText = "";
            return;
        }
        
        const r = list[Math.floor(Math.random() * list.length)];
        currentIndex = notes.indexOf(r);
        displayNote(r);
    }
    
    function displayNote(n) {
        document.getElementById('d-text').innerHTML = n.text;
        document.getElementById('d-tag').innerText = n.tag || 'IMP';
        const stars = parseInt(n.rating || 0);
        document.getElementById('d-stars').innerText = '‚òÖ'.repeat(stars);
    }

    /* --- ADD NOTE --- */
    function openAddNoteModal() {
        document.getElementById('add-editor').innerHTML = "";
        setStar(0, 'tempRatingAdd', 'add-stars-container'); // Reset stars
        document.getElementById('modal-add').style.display = 'flex';
    }

    function runAddNote() {
        const html = document.getElementById('add-editor').innerHTML;
        const txt = document.getElementById('add-editor').innerText;
        const tag = document.getElementById('add-tag-select').value;
        const rating = tempRatingAdd;

        if(!txt.trim()) return;

        let newNotes = [];
        
        // BULK IMPORT LOGIC (Plain Text & Stars)
        // Eƒüer formatlanmamƒ±≈ü metin * ile ba≈ülƒ±yorsa toplu ekle.
        // Formatlƒ± metin (bold, renkli vs) varsa tekli ekle.
        
        const isRich = html.includes('<') && html.includes('>'); // Basit html kontrol√º
        
        if (!isRich && /(^|\n)\s*\*+/.test(txt)) {
            const parts = txt.split(/(^|\n)\s*(?=\*)/g);
            parts.forEach(p => {
                let clean = p.trim();
                if(clean.startsWith('*')) {
                    const m = clean.match(/^(\*+)/);
                    let r = m ? m[1].length : 0; if(r>5) r=5;
                    clean = clean.replace(/^(\*+)\s*/, '');
                    if(clean) newNotes.push({text:clean, tag:tag, rating:r});
                }
            });
        } else {
            // Tekli Rich Text
            newNotes.push({ text: html, tag: tag, rating: rating > 0 ? rating : 1 });
        }
        
        if(newNotes.length === 0 && txt.length > 0) {
             newNotes.push({ text: html, tag: tag, rating: rating > 0 ? rating : 1 });
        }

        notes = [...notes, ...newNotes];
        closeModal('modal-add');
        saveToGoogle(notes).then(() => { showToast(newNotes.length + " Not Eklendi"); showRandom(); });
    }

    /* --- EDIT NOTE --- */
    function openEditModal() {
        if(currentIndex === -1) return;
        const n = notes[currentIndex];
        document.getElementById('edit-editor').innerHTML = n.text;
        document.getElementById('edit-tag-select').value = n.tag;
        // Mevcut puanƒ± set et
        setStar(parseInt(n.rating||0), 'tempRatingEdit', 'edit-stars-container');
        document.getElementById('modal-edit').style.display = 'flex';
    }

    function saveEdit() {
        const html = document.getElementById('edit-editor').innerHTML;
        const tag = document.getElementById('edit-tag-select').value;
        const rating = tempRatingEdit;
        
        notes[currentIndex] = { text: html, tag: tag, rating: rating };
        closeModal('modal-edit');
        displayNote(notes[currentIndex]);
        saveToGoogle(notes).then(() => showToast("Not G√ºncellendi"));
    }

    /* --- SETTINGS & TAGS --- */
    function openSettings() { 
        document.getElementById('settings-url').value = localStorage.getItem('imp_app_url') || "";
        document.getElementById('modal-settings').style.display = 'flex'; 
    }
    function saveSettings() {
        const url = document.getElementById('settings-url').value.trim();
        if(url) { localStorage.setItem('imp_app_url', url); GOOGLE_SCRIPT_URL = url; closeModal('modal-settings'); fetchNotes(); }
    }
    
    function openNewTagModal() { document.getElementById('modal-new-tag').style.display='flex'; }
    function createTag() {
        const n = document.getElementById('new-tag-name').value.trim();
        if(n && !tags.includes(n)) { tags.push(n); tags.sort(); renderSidebarTags(); closeModal('modal-new-tag'); }
    }
    
    function openTagOptions(t) { targetTagForOptions=t; document.getElementById('opt-tag-name').innerText=t; document.getElementById('modal-tag-options').style.display='flex'; }
    function openRenameFromOptions() { closeModal('modal-tag-options'); document.getElementById('rename-tag-input').value=targetTagForOptions; document.getElementById('modal-rename-tag').style.display='flex'; }
    
    function runDeleteTag() {
        if(confirm("Silmek istediƒüine emin misin?")) {
            notes.forEach(n => { if(n.tag===targetTagForOptions) n.tag="Genel"; });
            tags = tags.filter(t=>t!==targetTagForOptions);
            renderSidebarTags(); closeModal('modal-tag-options'); saveToGoogle(notes);
        }
    }
    function runRenameTag() {
        const nn = document.getElementById('rename-tag-input').value.trim();
        if(nn) {
            notes.forEach(n => { if(n.tag===targetTagForOptions) n.tag=nn; });
            const i = tags.indexOf(targetTagForOptions); if(i!==-1) tags[i]=nn;
            renderSidebarTags(); closeModal('modal-rename-tag'); saveToGoogle(notes);
        }
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = e => { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; }
</script>
</body>
</html>
